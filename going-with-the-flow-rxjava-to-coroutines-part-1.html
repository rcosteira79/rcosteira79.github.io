<!DOCTYPE html>
<html>
  <head>
    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Base Meta -->
    <!-- dynamically fixing the title for tag/author pages -->
 


    <title>
      
      Going with the Flow: from RxJava to Kotlin coroutines - Part 1
      
    </title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link
      rel="stylesheet"
      type="text/css"
      href="/assets/built/screen.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="/assets/built/screen.edited.css"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Roboto+Slab:700|Roboto:300,400&display=swap"
      rel="stylesheet"
    />
    <!--[if IE]>
      <style>
        p,
        ol,
        ul {
          width: 100%;
        }
        blockquote {
          width: 100%;
        }
      </style>
    <![endif]-->

    <!-- This tag outputs SEO meta+structured data and other important settings -->
    <meta
  name="description"
  content="A mobile software engineer with a passion for Android and clean, maintainable code. I build apps from the ground up and maintain existing ones. Currently out of my area of expertise in order to diversify my skills on software design and architecture."
/>
<link
  rel="shortcut icon"
  href="https://ricardocosteira.com/assets/images/favicon.png"
  type="image/png"
/>
<link
  rel="canonical"
  href="https://ricardocosteira.com/going-with-the-flow-rxjava-to-coroutines-part-1"
/>
<meta name="referrer" content="no-referrer-when-downgrade" />


<!--title below is coming from _includes/dynamic_title-->
<meta property="og:site_name" content="Ricardo Costeira" />
<meta property="og:type" content="website" />
<meta
  property="og:title"
  content="Going with the Flow: from RxJava to Kotlin coroutines - Part 1"
/>
<meta
  property="og:description"
  content="I’ve been playing around with Kotlin’s coroutines library. I had some trouble wrapping my head around the whole coroutine concept, mainly because I was consistently looking out for RxJava resemblances. Well, the truth is RxJava is one thing, and coroutines are another thing. Sure, they can be used for the"
/>
<meta
  property="og:url"
  content="https://ricardocosteira.com/going-with-the-flow-rxjava-to-coroutines-part-1"
/>
<meta
  property="og:image"
  content="https://ricardocosteira.com/assets/images/going-with-the-flow-rxjava-to-coroutines-part-1.jpg"
/>
<meta
  property="article:publisher"
  content="https://www.twitter.com/rcosteira79"
/>
<meta
  property="article:author"
  content="https://www.twitter.com/rcosteira79"
/>
<meta
  property="article:published_time"
  content="2019-08-19T01:00:00+01:00"
/>
<meta
  property="article:modified_time"
  content="2019-08-19T01:00:00+01:00"
/>
<meta
  property="article:tag"
  content="Android"
/>
<meta name="twitter:card" content="summary_large_image" />
<meta
  name="twitter:title"
  content="Going with the Flow: from RxJava to Kotlin coroutines - Part 1"
/>
<meta
  name="twitter:description"
  content="I’ve been playing around with Kotlin’s coroutines library. I had some trouble wrapping my head around the whole coroutine concept, mainly because I was consistently looking out for RxJava resemblances. Well, the truth is RxJava is one thing, and coroutines are another thing. Sure, they can be used for the"
/>
<meta name="twitter:url" content="https://ricardocosteira.com/" />
<meta
  name="twitter:image"
  content="https://ricardocosteira.com/assets/images/going-with-the-flow-rxjava-to-coroutines-part-1.jpg"
/>
<meta name="twitter:label1" content="Written by" />
<meta name="twitter:data1" content="Ricardo Costeira" />
<meta name="twitter:label2" content="Filed under" />
<meta
  name="twitter:data2"
  content="Android"
/>
<meta name="twitter:site" content="@rcosteira79" />
<meta name="twitter:creator" content="@rcosteira79" />
<meta property="og:image:width" content="1400" />
<meta property="og:image:height" content="933" />

<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
      "@type": "Organization",
      "name": "Ricardo Costeira",
      "logo": "https://ricardocosteira.com/"
    },
    "url": "https://ricardocosteira.com/going-with-the-flow-rxjava-to-coroutines-part-1",
    "image": {
      "@type": "ImageObject",
      "url": "https://ricardocosteira.com/assets/images/going-with-the-flow-rxjava-to-coroutines-part-1.jpg",
      "width": 2000,
      "height": 666
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://ricardocosteira.com/going-with-the-flow-rxjava-to-coroutines-part-1"
    },
    "description": "I’ve been playing around with Kotlin’s coroutines library. I had some trouble wrapping my head around the whole coroutine concept, mainly because I was consistently looking out for RxJava resemblances. Well, the truth is RxJava is one thing, and coroutines are another thing. Sure, they can be used for the"
  }
</script>

<meta name="generator" content="Jekyll 3.6.2" />
<link
  rel="alternate"
  type="application/rss+xml"
  title="Going with the Flow: from RxJava to Kotlin coroutines - Part 1"
  href="/feed.xml"
/>

    <link
      rel="stylesheet"
      type="text/css"
      href="/assets/built/prism.css"
    />
  </head>
  <body
    class="post-template"
  >
    <div class="site-wrapper">
      <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
      <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
  <div class="site-nav-left">
     <ul class="nav" role="menu">
    <li class="nav-home" role="menuitem"><a href="/">Home</a></li>
    <li class="nav-getting-started" role="menuitem"><a href="/tag/android/">Android</a></li>
    <li class="nav-about" role="menuitem"><a href="/about/">About</a></li>
</ul>
 
  </div>
  <div class="site-nav-right">
    <div class="social-links">
      
<a
  class="social-link social-link-gh"
  href="https://github.com/rcosteira79"
  target="_blank"
  rel="noopener"
  ><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a
>
 
<a
  class="social-link social-link-tw"
  href="https://twitter.com/rcosteira79"
  target="_blank"
  rel="noopener"
  ><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>
</a
>
 
<a
  class="social-link social-link-lkd"
  href="https://linkedin.com/in/rcosteira"
  target="_blank"
  rel="noopener"
  ><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M4.98 3.5c0 1.381-1.11 2.5-2.48 2.5s-2.48-1.119-2.48-2.5c0-1.38 1.11-2.5 2.48-2.5s2.48 1.12 2.48 2.5zm.02 4.5h-5v16h5v-16zm7.982 0h-4.968v16h4.969v-8.399c0-4.67 6.029-5.052 6.029 0v8.399h4.988v-10.131c0-7.88-8.922-7.593-11.018-3.714v-2.155z"/></svg></a
>
 
<a
  class="social-link social-link-stackoverflow"
  href="https://stackoverflow.com/users/2333010/ricardo-costeira"
  target="_blank"
  rel="noopener"
  ><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M15 21h-10v-2h10v2zm6-11.665l-1.621-9.335-1.993.346 1.62 9.335 1.994-.346zm-5.964 6.937l-9.746-.975-.186 2.016 9.755.879.177-1.92zm.538-2.587l-9.276-2.608-.526 1.954 9.306 2.5.496-1.846zm1.204-2.413l-8.297-4.864-1.029 1.743 8.298 4.865 1.028-1.744zm1.866-1.467l-5.339-7.829-1.672 1.14 5.339 7.829 1.672-1.14zm-2.644 4.195v8h-12v-8h-2v10h16v-10h-2z"/></svg></a
>
 
<a
  class="social-link social-link-medium"
  href="https://medium.com/@rcosteira79"
  target="_blank"
  rel="noopener"
  ><svg xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" viewBox="0 0 32 32"><path d="M2.846 6.887c.03-.295-.083-.586-.303-.784l-2.24-2.7v-.403h6.958l5.378 11.795 4.728-11.795h6.633v.403l-1.916 1.837c-.165.126-.247.333-.213.538v13.498c-.034.204.048.411.213.537l1.871 1.837v.403h-9.412v-.403l1.939-1.882c.19-.19.19-.246.19-.537v-10.91l-5.389 13.688h-.728l-6.275-13.688v9.174c-.052.385.076.774.347 1.052l2.521 3.058v.404h-7.148v-.404l2.521-3.058c.27-.279.39-.67.325-1.052v-10.608z"/></svg></a
>
 
<a
  class="social-link social-link-devto"
  href="https://dev.to/rcosteira79"
  target="_blank"
  rel="noopener"
  ><svg role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path  fill="#ffffff" d="M120.12 208.29c-3.88-2.9-7.77-4.35-11.65-4.35H91.03v104.47h17.45c3.88 0 7.77-1.45 11.65-4.35 3.88-2.9 5.82-7.25 5.82-13.06v-69.65c-.01-5.8-1.96-10.16-5.83-13.06zM404.1 32H43.9C19.7 32 .06 51.59 0 75.8v360.4C.06 460.41 19.7 480 43.9 480h360.2c24.21 0 43.84-19.59 43.9-43.8V75.8c-.06-24.21-19.7-43.8-43.9-43.8zM154.2 291.19c0 18.81-11.61 47.31-48.36 47.25h-46.4V172.98h47.38c35.44 0 47.36 28.46 47.37 47.28l.01 70.93zm100.68-88.66H201.6v38.42h32.57v29.57H201.6v38.41h53.29v29.57h-62.18c-11.16.29-20.44-8.53-20.72-19.69V193.7c-.27-11.15 8.56-20.41 19.71-20.69h63.19l-.01 29.52zm103.64 115.29c-13.2 30.75-36.85 24.63-47.44 0l-38.53-144.8h32.57l29.71 113.72 29.57-113.72h32.58l-38.46 144.8z"></path></svg></a
>


    </div>
    
  </div>
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full post tag-android ">

            <header class="post-full-header">
                <section class="post-full-meta">
                    <time class="post-full-meta-date" datetime="19 August 2019">19 August 2019</time>
                    
                        <span class="date-divider">/</span>
                        
                            
                               <a href='/tag/android/'>ANDROID</a>
                            
                        
                    
                </section>
                <h1 class="post-full-title">Going with the Flow: from RxJava to Kotlin coroutines - Part 1</h1>
                
                    <h2 class="post-full-subtitle">Refactoring an API request</h2>
                
            </header>

            
            <div class="post-full-image-caption">
                <figure class="post-full-image" style="background-image: url(/assets/images/going-with-the-flow-rxjava-to-coroutines-part-1.jpg)"></figure>
                
                
                    Photo by <a href="https://unsplash.com/@dnevozhai">Denys Nevozhai</a>
                

                
                    
                        on <a href="https://unsplash.com">Unsplash</a>.
                    
                
            </div>
            

            <section class="post-full-content">
                <div class="kg-card-markdown">
                    <p>I’ve been playing around with Kotlin’s coroutines library. I had some trouble wrapping my head around the whole coroutine concept, mainly because I was consistently looking out for RxJava resemblances. Well, the truth is RxJava is one thing, and coroutines are another thing. Sure, they can be used for the same use cases, but they’re two different concepts. I’ll try not to go too deep into the rabit hole here, but RxJava is an API for asynchronous and/or concurrent programming that follows the <strong>functional</strong> and <strong>reactive</strong> paradigms. On the other hand, the coroutines library aims to facilitate asynchronous and/or concurrent programming, while <strong>deferring the decision of going functional or reactive to the user</strong>. Once I became aware of this, coroutines became a lot easier to understand. And it took me a lot less time than RxJava. I dare say that this might mean they’re easier to grasp for beginners, or at least to someone that’s not familiarized with RxJava.</p>

<p>In this article series, I’ll go through a sample app built with RxJava and refactor it using the coroutines library. The plan for the series is to:</p>

<ul>
  <li>Refactor API requests with coroutines;</li>
  <li>Refactor a Database event subscription with Flow;</li>
  <li>Refactor a UI interaction with Flow and Channels;</li>
</ul>

<p>I will show you both implementations and explain the reasoning behind them, albeit assuming that you’re at least familiar with RxJava. I will measure performance (I’m an Engineer™) and show you how can you write tests for both versions. In this article, I’ll start with the refactoring that, in my opinion, lays the foundation to understand the upcoming ones - refactoring API requests with coroutines. So, let’s get started.</p>

<h3 id="the-app">The app</h3>

<p>Well, more like “The view”. I didn’t want to show you just small “before” and “after” code samples, but I also didn’t want to make an extremely complex and hard to follow app.</p>

<figure>
  <img src="https://ricardocosteira.com/assets/images/going-with-the-flow-rxjava-to-coroutines-part-1-1.png" alt="App screenshot" />
  <figcaption>Design skills too stronk.</figcaption>
</figure>

<p>The UI is composed by a <code>Fragment</code> with a search bar and a <code>RecyclerView</code> (don’t mind the <code>BottomNavigationView</code>, it’s there just so that I can jump between different code samples - this is my skeleton/playground project). Each <code>RecyclerView</code> item shows a card with user information. When the app starts, it checks the database for existing data, and displays it accordingly. It also queries the Github API for more data in order to update the database. The search bar filters the user list by name, and the <em>DELETE</em> button on each card sends a delete command to the database for the corresponding user.</p>

<p>I’m using Room for the database and Retrofit for the Github API requests. Dependencies are provided by Dagger. The app as a whole is built using a common pattern (<a href="http://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html">Clean Architecture</a>). State is managed through view state and view event classes. Data flow between the view and the <code>ViewModel</code> is unidirectional. If you want to know more about the implementation details, you can check the <a href="https://github.com/rcosteira79/AndroidMultiModuleCleanArchTemplate">repository</a>. That said, let’s dive into the API request details.</p>

<h3 id="handling-an-api-request-with-rxjava">Handling an API request with RxJava</h3>

<p>To fetch the users we need to contact the Github API. However, some of the information we want to show, such as location or blog url, are not available in the list that the API returns. As such, we need to do another request - one for <strong>each</strong> user - to retrieve those details.</p>

<p>Given this, the app has the following Retrofit API:</p>

<pre><code class="language-Kotlin">interface Api {
  @GET("users")
  fun getAllUsers(): Maybe&lt;List&lt;GithubUser&gt;&gt;

  @GET("users/{username}")
  fun getUserDetails(@Path("username") username: String): Maybe&lt;GithubDetailedUser&gt;
}
</code></pre>

<p>Yes, I could use <code>Observable</code> instead of <code>Maybe</code> here, but <code>Maybe</code> makes more <em>semantic</em> meaning to me: maybe I’ll get the response I expect, or maybe I won’t. Still, <code>getAllUsers</code> returns a <code>List&lt;GithubUser&gt;</code> stream, and we need to operate on each individual user. So the <strong>repository</strong> converts this stream into an <code>Observable</code> stream of <code>GithubUser</code>. The other stream remains the same:</p>

<pre><code class="language-Kotlin">override fun getUsersFromApi(): Observable&lt;User&gt; {
  return api.getAllUsers() // returns Maybe for semantic purposes - one possible response on each request.
    .flattenAsObservable { it } // However, we need to transform each element of the list
    .map { userMapper.mapToEntity(it) }
}

override fun getUserDetailsFromApi(username: Username): Maybe&lt;DetailedUser&gt; {
  return api.getUserDetails(username.value) // Username is an inline class. Handy for domain modeling!
    .map { detailedUserMapper.mapToEntity(it) }
}
</code></pre>

<p>Following Clean Architecture, I have <code>UseCase</code> classes connecting the <code>ViewModel</code> to the repository. Regardless, I’m skipping them here since I’m only using them to forward the calls from the <code>ViewModel</code> to the repository. This is actually something that bothers me, because according to the Clean Architecture definition, a use case is called a “use case” because it encapsulates use case logic. On Android though, we tend to keep the this logic both in the repository and the <code>ViewModel</code> (at least in most Clean Architecture implementations I’ve seen so far). In other words, the <code>UseCase</code> classes are used only to improve code readability - as their intent is, by nature, straightforward - and define boundaries. Since most of the work done by an Android app is fetching data from wherever and showing it on the screen, one might wonder if the extra classes, extra maintenance effort, extra performance cost and extra APK size increase are really worth it. Anyway, this is a subject for another article, maybe. Back to the refactoring.</p>

<p>The API is ready, and the repository is ready. Now we just need to make the call in the <code>ViewModel</code>, and subscribe to it:</p>

<pre><code class="language-Kotlin">// Gets users from the api and stores them in the database
private fun updateCache() {
  getUsersFromApiAsSingle()
    .doOnSuccess { Logger.d("Updating database") }
    .subscribeOn(Schedulers.io())
    .subscribe(
      { updateCachedUsers(it) }, //onSuccess
      { handleErrors(it) } // onError
    )
    .addTo(compositeDisposable) // Extension function
}

private fun getUsersFromApiAsSingle(): Single&lt;List&lt;DetailedUser&gt;&gt; {
  return getUsersFromApi(NoParameters()) // NoParameters is a UseCase implementation detail
    .take(10) // Github API has a hourly call limit :D and 10 are more than enough for what we're doing
    .flatMapMaybe { getUserDetailsFromApi(it.username) } // 2nd api call with information from the 1st one
    .toList() // gather all stream events back into one Single list
}
</code></pre>

<p>I’m going to pretend I don’t have all these layers and boundaries for a second, so that the whole process is easier to visualize:</p>

<pre><code class="language-Kotlin">api.getAllUsers() // returns Maybe for semantic purposes - one possible response on each request.
  .flattenAsObservable { it } // However, we need to transform each element of the list
  .map { userMapper.mapToEntity(it) }
  .take(10) // Github API has a hourly call limit :D and 10 are more than enough for what we're doing
  .flatMapMaybe { // 2nd api call with information from the 1st one
      api.getUserDetails(username.value)
          .map { detailedUserMapper.mapToEntity(it) }
  }
  .toList() // gather all stream events back into one Single list -&gt; Single&lt;List&lt;DetailedUser&gt;&gt;
  .doOnSuccess { Logger.d("Updating database") }
  .subscribeOn(Schedulers.io())
  .subscribe(
    { updateCachedUsers(it) }, //onSuccess
    { handleErrors(it) } // onError
  )
  .addTo(compositeDisposable) // Extension function
</code></pre>

<p>Ok, so what’s happening here?</p>

<ul>
  <li>We send a request to the API and get back a <code>Maybe&lt;List&lt;GithubUser&gt;&gt;</code> stream;</li>
  <li>We flatten the list into an <code>Observable&lt;GithubUser&gt;</code> stream;</li>
  <li>We map each element to a domain entity called <code>User</code> (even though I’m pretending there are no boundaries, I left this mapping on purpose since it’s part of the stream’s operations);</li>
  <li>We take the first ten elements just because we’ll have to do another API call for each user, and Github has a very low limit for unauthenticated requests;</li>
  <li>We use <code>flatMapMaybe</code> to get the user details for each of the ten users, and map each one of the returned objects (<code>GithubDetailedUser</code>) to a domain entity called <code>DetailedUser</code>. Why <code>flatMapMaybe</code> instead of a regular <code>flatMap</code>? Because the <code>getUserDetails</code> API call returns a <code>Maybe&lt;GithubDetailedUser&gt;</code>, and a simple <code>flatMap</code> requires that you provide it with the same kind of stream you apply it on, since it has to return the same type (in this case, an <code>Observable</code> stream). As such, <code>flatMapMaybe</code> is expecting a Maybe stream as its parameter, and returns an <code>Observable</code> stream at the end;</li>
  <li>After <code>flatMapMaybe</code> does its magic and flattens the incoming streams into one <code>Observable&lt;DetailedUser&gt;</code> stream, we call the <code>toList</code> operator, which in turn will output a <code>Single&lt;List&lt;DetailedUser&gt;&gt;</code> stream;</li>
  <li>Finally, we do some logging, bind all operations to a thread from the IO pool and subscribe to the whole thing. Since the last operation outputs a <code>Single</code> stream, the observer only has two functions: an <code>onSuccess</code> lambda that calls the <code>updateCachedUsers</code> method, and an <code>onError</code> lambda that calls the <code>handleErrors</code> method. If everything goes through the happy path, <code>updateCachedUsers</code> then proceeds to update the database with the information it gets as parameter, i.e. a <code>List&lt;DetailedUser&gt;</code>. The lack of an <code>observeOn</code> operator is not a bug: <code>updateCachedUsers</code> is supposed to run in the background, so we can keep the stream running in the same thread.</li>
</ul>

<p>Whew. That’s a whole lot of stream operations. But it does exactly what we want: it fetched data from a remote API and updates the local database, all in an asynchronous - and partially concurrent, thanks to the flatMapMaybe - fashion. Let’s see how can we do the same with coroutines.</p>

<h3 id="coroutines">Coroutines</h3>

<p>First, I want to talk a little about how coroutines work in Kotlin. I’ll only graze the surface on the topic, but it should be enough to get you started. To make it easier to process, I’ll talk about the basic coroutine theory now, and then talk about the practical concepts as they show up while refactoring. If you already understand how coroutines work under the hood, you can skip to the next section.</p>

<p>So, a coroutine is a construct meant to turn async programming into a walk in a park. They are usually referred to as <em>lightweigth threads</em>, since they are so much lighter to use than a regular thread. On Android at least, a typical thread occupies 1 to 2 MB of memory (that’s why we love thread pools!). Each Java thread gets mapped to a kernel thread, which means that the OS manages them. The OS then schedules which thread runs at a given time, jumps between them (context switching), has to invalidate cache in the process… All of these and other related operations have their performance cost.</p>

<p>Coroutines are executed in threads. These threads come from thread pools managed by coroutines themselves. Coroutines are not bound to any particular thread, which means that they can start in one thread, <em>suspend</em>, and resume in another thread. Since this process is fully managed by coroutines through <code>Continuation</code>s, we don’t get the context switching overhead (more on this in a minute). They also aren’t managed by the OS, which automatically frees us from the thread scheduler overhead mentioned above. The coroutine object in itself has a small memory footprint (bytes), which means that you can have a bunch of them being executed at the same time without having to worry about running out of memory. There are a few examples online where people launch 100.000 coroutines at the same time without having any problems at all, while getting an OutOfMemoryException when they try to do the same with regular threads.</p>

<p>I mentioned <code>Continuation</code> before. This happens to be one of the most important aspects about coroutines, if not the most important. Kotlin coroutines implement what is called a <strong>continuation passing style</strong>. Whenever you write a <strong>suspendable function</strong> (you’ve probably seen <code>suspend fun</code> written somewhere by now), you’re letting Kotlin know that this function is to be executed in a coroutine. Why? Because under the hood, the compiler translates the <code>suspend fun</code> to a function that receives a <code>Continuation</code> as a parameter! So, when you write something like this</p>

<pre><code class="language-Kotlin">suspend fun login(user: User): Token { ... }
</code></pre>

<p>It gets decompiled to something similar to</p>

<pre><code class="language-Java">Object login(User user, Continuation&lt;Token&gt; continuation) { ... }
</code></pre>

<p>Every time a coroutine suspends, it stores its state in the continuation. When it wants to resume its execution, it only has to check the continuation for the information it needs, and that’s it. This seamless suspend-resume process is what allows us to write seemingly <strong>sequential</strong> code instead of callbacks for async work. Whenever there’s async work to be done, the coroutine suspends, and later resumes when the work is done. Meanwhile, the world keeps spinning like nothing’s going on, as this suspension <strong>does not</strong> block the thread the coroutine is running on. In fact, while this coroutine is suspended, another coroutine can immediately start some work on the same thread.</p>

<p>Ok, you’re still reading. I know this is a lot, but hopefully it’ll help you understand things when we get our hands on the code (it certainly did help me).</p>

<h3 id="handling-an-api-request-with-coroutines">Handling an API request with coroutines</h3>

<p>Retrofit has native support for coroutines, so the first step is to add the <code>suspend</code> keyword to the methods and change their return parameters:</p>

<pre><code class="language-Kotlin">@GET("users")
suspend fun getAllUsers(): List&lt;GithubUser&gt;

@GET("users/{username}")
suspend fun getUserDetails(@Path("username") username: String): GithubDetailedUser
</code></pre>

<p>Easy enough. Now, propagate the same changes to the repository:</p>

<pre><code class="language-Kotlin">override suspend fun getUsersFromApi(): List&lt;User&gt; {
  return api.getAllUsers()
    .map { userMapper.mapToEntity(it) }
}

override suspend fun getUserDetailsFromApi(username: Username): DetailedUser {
  val detailedUser = api.getUserDetails(username.value)
  return detailedUserMapper.mapToEntity(detailedUser)
}
</code></pre>

<p>It’s not that different from what we had before. We’re still just mapping the data entities to domain entities. Nothing more.</p>

<p>Next up is the <code>ViewModel</code>. Here is where the differences are noticeable:</p>

<pre><code class="language-Kotlin">private fun updateCacheWithCoroutines() {
  // I don't like try-catch. So we're using an exception handler instead
  val exceptionHandler = CoroutineExceptionHandler { _, throwable -&gt;
    handleErrors(throwable)
  }

  // we want the coroutine to be bounded to the `ViewModel`'s lifecycle (it's on the main thread)
  viewModelScope.launch(exceptionHandler) {
    // But the request should go to the backgound
    withContext(Dispatchers.IO) {
      getUsersFromApiThroughCoroutine(this)
    } // Don't forget: at this point, we're in the main thread context again!
  }
}

private suspend fun getUsersFromApiThroughCoroutine(coroutineScope: CoroutineScope) {
  val userList = getUsersFromApi(NoParameters()) // List&lt;User&gt;
    .take(10) // Github API has a hourly call limit :D and 10 are more than enough for what we're doing
    .map { coroutineScope.async { getUserDetailsFromApi(it.username) } } // Yay concurrency!
    .map { it.await() } // Wait for them to finish... These two last maps are pretty much a flatMap

  if (userList.isNotEmpty()) {
    Logger.d("Updating database")
    updateCachedUsers(userList)
  }
}
</code></pre>

<p>Before I start explaining what’s happening here, there are a few keypoints that you need to be aware of (if you know how coroutines are launched and what contexts and jobs are, you can skip to the next code snippet):</p>

<ul>
  <li>Coroutines are launched through a <code>CoroutineBuilder</code>. The typical ones are <code>launch</code> and <code>async</code> (theres also <code>runBlocking</code>, which we’ll use for testing). As you can see above, you can launch coroutines inside coroutines: we’re launching coroutines with <code>async</code>, while in another coroutine that was launched by <code>launch</code>. The <code>async</code> builder is used for concurrent tasks. You execute concurrent coroutines with it and wait for them with the <code>await</code> suspending function, which suspends the parent coroutine until the async children finish;</li>
  <li><code>Dispatchers</code> are used to confine coroutine execution to specific threads. They are used either with a <code>CoroutineBuilder</code> or with the <code>withContext</code> suspendable function;</li>
  <li>Every coroutine is bound to a <code>CoroutineScope</code>. These scopes let you bind the coroutine to specific lifecycles. <code>CoroutineBuilder</code>s are actually extension functions defined in <code>CoroutineScope</code> types (except for <code>runBlocking</code>). On Android, we probably want to avoid <code>GlobalScope</code>, which is meant for coroutines that run throughout the app’s lifetime. In the code, I use a <code>ViewModelScope</code> to bind the coroutines to the <code>ViewModel</code>’s lifecycle;</li>
  <li>Coroutines can be cancelled. We can cancel them either by throwing a <code>CancellationException</code> or through a <code>Job</code>. Every coroutine is associated with a <code>Job</code>. Canceling a <code>Job</code> will cancel its coroutine. <code>Job</code>s can form parent-child hierarchies, where cancellation of the parent also cancels all children, and failure/cancellation of a child also cancels the parent (except if the child throws a <code>CancellationException</code>). There’s also the <code>SupervisorJob</code>, where a child can fail without affecting other children or the parent. The typical way to obtain a coroutine’s <code>Job</code> is either by storing the return value of the <code>launch</code> builder, or by accessing it directly inside the coroutine;</li>
  <li>Just like Android, coroutines have a <strong>context</strong>. It’s main elements are the coroutine’s <code>Job</code> and <code>Dispatcher</code>. When the coroutine is launched, we have the choice of passing a <code>CoroutineContext</code> to the builder. If we don’t, it’ll use a default one. We can also change the coroutine’s context later through the <code>withContext</code> function. A bunch of different classes implement the <code>CoroutineContext</code> interface, which is really handy (for instance, <code>Dispatchers</code> implement it, so we can pass them to a <code>CoroutineBuilder</code> or <code>withContext</code>).</li>
</ul>

<p>Back to the code. Like I did with the RxJava version, I’m going to pretend that there are no layers and join the whole thing:</p>

<pre><code class="language-Kotlin">// I don't like try-catch. So we're using an exception handler instead
val exceptionHandler = CoroutineExceptionHandler { _, throwable -&gt;
  handleErrors(throwable)
}

// we want the coroutine to be bounded to the `ViewModel`'s lifecycle (it's on the main thread)
viewModelScope.launch(exceptionHandler) {
  // But the request should go to the background
  withContext(Dispatchers.IO) {
    val userList = api.getAllUsers()
      .map { userMapper.mapToEntity(it) }
      .take(10) // Github API has a hourly call limit :D and 10 are more than enough for what we're doing
      .map {
        async { // Yay concurrency!
          val detailedUser = api.getUserDetails(it.username.value)
          detailedUserMapper.mapToEntity(detailedUser)
        }
      }
      .map { it.await() } // Wait for all calls to finish... These two last maps are pretty much a flatMap

    if (userList.isNotEmpty()) {
      Logger.d("Updating database")
      updateCachedUsers(userList)
    }
  } // Don't forget: at this point, we're in the main thread context again!
}
</code></pre>

<p>Lets begin:</p>

<ul>
  <li>We start by creating a <code>CoroutineExceptionHandler</code>. Coroutines bubble up exceptions all the way to the top-most coroutine, so instead of having <code>try-catch</code> blocks all over the place, we pass an exception handler <strong>to the top-most coroutine</strong>. This handler works for simple cases, as it will handle all exceptions (note that child coroutines can still have their own exception handling mechanisms);</li>
  <li>We <code>launch</code> a coroutine on the <code>viewModelScope</code> and pass it the exception handler (<code>CoroutineExceptionHandler</code> also implements <code>CoroutineContext</code>). By launching the coroutine on this scope, we’re also binding it to the <strong>main thread</strong>. On a side note, we need to clear all the <code>viewModelScope</code>’s <code>Job</code>s at the end of the <code>ViewModel</code>’s lifecycle, just like we do with Rx’s <code>CompositeDisposable</code>;</li>
  <li>As soon as we start the coroutine, we change its context so that it’ll run on the IO thread pool. Now, this is <strong>very</strong> important: the code inside <code>withContext</code>’s lambda will run on an IO thread. As <strong>soon</strong> as the lambda ends in line 25, we’re back to the main thread! Unlike RxJava where we’re used to bind the upstream to a thread and the downstream to another thread, coroutines rely on the actual <strong>blocks</strong> of code. In other words, everything inside the <code>launch {}</code> block will run on the main thread, but since we explicitly specify that an inner block should run on an IO thread with <code>withContext</code>, so it will be;</li>
  <li>We get the users from the API, map them to domain entities and take the first ten;</li>
  <li>Now for the other interesting bit. For each <code>User</code>, we’re launching a new coroutine with <code>async</code> in order to fetch the details from the API. We then map each response item to a domain entity. Due to the <code>async</code> calls, this <code>map</code> will return <code>List&lt;Deferred&lt;DetailedUser&gt;&gt;</code>, as each <code>async</code> returns a <code>Deferred&lt;T&gt;</code> type. All <code>async</code> calls effectively run in a concurrent manner;</li>
  <li>Right below, we have another <code>map</code> being called. We’re calling it so that we can call <code>await</code> on each of the <code>Deferred</code> values, in order for the coroutine to suspend until they all finish. In the end, by using this <code>map</code> together with the one with the <code>async</code> calls, we’re mimicking what an Rx’s <code>flatMap</code> would do;</li>
  <li>That’s it. The rest is just sequential, normal code. However, a side note on this. <code>updateCachedUsers</code> is a call that gets propagated through the repository until it triggers Room to actually update itself with the new data. Now, the caveat: if the actual Room function was a <code>suspend</code> function, this <code>updateCachedUsers</code> call above would have to be out the <code>withContext</code> block, and be executed in the main thread. As it turns out, Room <code>suspend</code> functions are <strong>main-safe</strong>, as Room uses its own custom <code>Dispatcher</code> - calling it from any other thread other that main will only slow things down.</li>
</ul>

<h3 id="final-words">Final words</h3>

<p>This concludes the part 1 of this series. I wanted to include both testing and performance measurements for this refactoring in this article as well, but damn, this is already huge as it is. That said, in part 2 I’ll be writing about how can you unit test both implementations (although I don’t agree that you should in this specific case, but I’ll explain why in the article) and compare them both in terms of performance. I’m expecting them to be really close to each other in execution time, but I’m rather curious with the memory footprint of each implementation. If I had to bet, I’d say that RxJava is heavier on memory usage, but we’ll see.</p>

<p>As for RxJava vs. coroutines… Well, as I said in the begining, you really can’t compare two different things. The only thing I can say right now is that both are really fun to use, and if your RxJava use case is one where you only use it for network calls <strong>and you’re looking for an alternative</strong>, you should totally consider coroutines.</p>

<hr />

<p>Thank you so much for taking your time to read this. Do you have any thoughts or opinions? If so, please leave a comment or reach out on Twitter. See you in part 2!</p>

                </div>
            </section>

            <!-- Email subscribe form at the bottom of the page -->
            

            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                <!-- 
                    
                        <section class="author-card">
                            
                            <section class="author-card-content">
                                <h4 class="author-card-name"><a href="/author/ricardo">Ricardo Costeira</a></h4>
                                
                                    <p>Read <a href="/author/ricardo">more posts</a> by this author.</p>
                                
                            </section>
                        </section>
                        <div class="post-full-footer-right">
                            <a class="author-card-button" href="/author/ricardo">Read More</a>
                        </div>
                    
                 -->
                <!-- /author  -->
            </footer>

            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            
                <section class="post-full-comments">
                    <div id="disqus_thread"></div>
                    <script>
                        var disqus_config = function () {
                            this.page.url = 'https://ricardocosteira.com/going-with-the-flow-rxjava-to-coroutines-part-1';
                            this.page.identifier = '/going-with-the-flow-rxjava-to-coroutines-part-1';
                        };
                        (function() {
                            var d = document, s = d.createElement('script');
                            s.src = 'https://ricardocosteira-com.disqus.com/embed.js';
                            s.setAttribute('data-timestamp', +new Date());
                            (d.head || d.body).appendChild(s);
                        })();
                    </script>
                </section>
            

        </article>

    </div>
</main>

<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
                
                
                
                
                    <article class="read-next-card"
                        
                            style="background-image: url(/assets/images/cover.jpeg)"
                        
                    >
                        <header class="read-next-card-header">
                            <small class="read-next-card-header-sitetitle">&mdash; Ricardo Costeira &mdash;</small>
                            
                                <h3 class="read-next-card-header-title"><a href="/tag/android/">Android</a></h3>
                            
                        </header>
                        <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
</div>
                        <div class="read-next-card-content">
                            <ul>
                                
                                
                                  
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/how-not-to-use-sealed-classes-and-livedata-for-state-management">How not to use sealed classes and LiveData for state management</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/encapsulate-and-abstract-for-future-proof-software">Encapsulate and abstract for future proof software</a></li>
                                        
                                    
                                  
                                
                            </ul>
                        </div>
                        <footer class="read-next-card-footer">
                            <a href="/tag/android/">
                                
                                
                                    See all 2 posts  →
                                
                            </a>
                        </footer>
                    </article>
                
            

            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            

            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/how-not-to-use-sealed-classes-and-livedata-for-state-management">
                <div class="post-card-image" style="background-image: url(/assets/images/how-not-to-use-sealed-classes-and-livedata-for-state-management.jpg)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/how-not-to-use-sealed-classes-and-livedata-for-state-management">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Android</span>
                            
                        
                    

                    <h2 class="post-card-title">How not to use sealed classes and LiveData for state management</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p>A few months ago, I was washing my dishes while listening to episode 148 of the Fragmented podcast. In this episode, Donn Felker and Kaushik Gopal talk about architecture. To be specific, about</p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                <!-- 
                    
                        
                        <span class="post-card-author">
                            <a href="/author/ricardo/">Ricardo Costeira</a>
                        </span>
                    
                 -->
                <span class="reading-time">
                    
                    
                      9 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

        </div>
    </div>
</aside>

<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
  <div class="floating-header-logo">
    <a href="https://ricardocosteira.com/">
      
      <img
        src="/assets/images/favicon.png"
        alt="Ricardo Costeira icon"
      />
      
      <span style="letter-spacing: 0.05em;">Ricardo Costeira</span>
    </a>
  </div>
  <span class="floating-header-divider">&mdash;</span>
  <div class="floating-header-title">Going with the Flow: from RxJava to Kotlin coroutines - Part 1</div>
  <div class="floating-header-share">
    <div class="floating-header-share-label">Share</div>
    <a
      class="floating-header-share-tw"
      href="https://twitter.com/share?text=Going+with+the+Flow%3A+from+RxJava+to+Kotlin+coroutines+-+Part+1&amp;url=https://ricardocosteira.com/going-with-the-flow-rxjava-to-coroutines-part-1"
      onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;"
    >
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

    </a>
    <a
      class="floating-header-share-fb"
      href="https://www.facebook.com/sharer/sharer.php?u=https://ricardocosteira.com/going-with-the-flow-rxjava-to-coroutines-part-1"
      onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;"
    >
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>
    </a>
    <a
      class="floating-header-share-lkd"
      href="https://www.linkedin.com/shareArticle/?mini=true&url=https://ricardocosteira.com/going-with-the-flow-rxjava-to-coroutines-part-1
        &title=Going with the Flow: from RxJava to Kotlin coroutines - Part 1
        &source=https://ricardocosteira.com"
      onclick="window.open(this.href, 'share-linkedin','width=500,height=500');return false;"
    >
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M4.98 3.5c0 1.381-1.11 2.5-2.48 2.5s-2.48-1.119-2.48-2.5c0-1.38 1.11-2.5 2.48-2.5s2.48 1.12 2.48 2.5zm.02 4.5h-5v16h5v-16zm7.982 0h-4.968v16h4.969v-8.399c0-4.67 6.029-5.052 6.029 0v8.399h4.988v-10.131c0-7.88-8.922-7.593-11.018-3.714v-2.155z"/></svg>
    </a>
  </div>
  <progress class="progress" value="0">
    <div class="progress-container">
      <span class="progress-bar"></span>
    </div>
  </progress>
</div>


<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


      <!-- Previous/next page links - displayed on every page -->
      

      <!-- The footer at the very bottom of the screen -->
      <footer class="site-footer outer">
        <div class="site-footer-content inner">
          <section class="copyright">
            <a href="https://ricardocosteira.com/">Ricardo Costeira</a>
            &copy; 2019
          </section>
          <section class="poweredby">
            Published with <a href="https://jekyllrb.com/">Jekyll</a> &
            <a href="https://pages.github.com/" target="_blank" rel="noopener"
              >GitHub Pages</a
            >. Based on
            <a
              href="https://github.com/jekyller/jasper2"
              target="_blank"
              rel="noopener"
              >Jasper2</a
            >
          </section>
          <nav class="site-footer-nav">
            
<a
  class="social-link social-link-gh"
  href="https://github.com/rcosteira79"
  target="_blank"
  rel="noopener"
  ><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a
>
 
<a
  class="social-link social-link-tw"
  href="https://twitter.com/rcosteira79"
  target="_blank"
  rel="noopener"
  ><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>
</a
>
 
<a
  class="social-link social-link-lkd"
  href="https://linkedin.com/in/rcosteira"
  target="_blank"
  rel="noopener"
  ><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M4.98 3.5c0 1.381-1.11 2.5-2.48 2.5s-2.48-1.119-2.48-2.5c0-1.38 1.11-2.5 2.48-2.5s2.48 1.12 2.48 2.5zm.02 4.5h-5v16h5v-16zm7.982 0h-4.968v16h4.969v-8.399c0-4.67 6.029-5.052 6.029 0v8.399h4.988v-10.131c0-7.88-8.922-7.593-11.018-3.714v-2.155z"/></svg></a
>
 
<a
  class="social-link social-link-stackoverflow"
  href="https://stackoverflow.com/users/2333010/ricardo-costeira"
  target="_blank"
  rel="noopener"
  ><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M15 21h-10v-2h10v2zm6-11.665l-1.621-9.335-1.993.346 1.62 9.335 1.994-.346zm-5.964 6.937l-9.746-.975-.186 2.016 9.755.879.177-1.92zm.538-2.587l-9.276-2.608-.526 1.954 9.306 2.5.496-1.846zm1.204-2.413l-8.297-4.864-1.029 1.743 8.298 4.865 1.028-1.744zm1.866-1.467l-5.339-7.829-1.672 1.14 5.339 7.829 1.672-1.14zm-2.644 4.195v8h-12v-8h-2v10h16v-10h-2z"/></svg></a
>
 
<a
  class="social-link social-link-medium"
  href="https://medium.com/@rcosteira79"
  target="_blank"
  rel="noopener"
  ><svg xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" viewBox="0 0 32 32"><path d="M2.846 6.887c.03-.295-.083-.586-.303-.784l-2.24-2.7v-.403h6.958l5.378 11.795 4.728-11.795h6.633v.403l-1.916 1.837c-.165.126-.247.333-.213.538v13.498c-.034.204.048.411.213.537l1.871 1.837v.403h-9.412v-.403l1.939-1.882c.19-.19.19-.246.19-.537v-10.91l-5.389 13.688h-.728l-6.275-13.688v9.174c-.052.385.076.774.347 1.052l2.521 3.058v.404h-7.148v-.404l2.521-3.058c.27-.279.39-.67.325-1.052v-10.608z"/></svg></a
>
 
<a
  class="social-link social-link-devto"
  href="https://dev.to/rcosteira79"
  target="_blank"
  rel="noopener"
  ><svg role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path  fill="#ffffff" d="M120.12 208.29c-3.88-2.9-7.77-4.35-11.65-4.35H91.03v104.47h17.45c3.88 0 7.77-1.45 11.65-4.35 3.88-2.9 5.82-7.25 5.82-13.06v-69.65c-.01-5.8-1.96-10.16-5.83-13.06zM404.1 32H43.9C19.7 32 .06 51.59 0 75.8v360.4C.06 460.41 19.7 480 43.9 480h360.2c24.21 0 43.84-19.59 43.9-43.8V75.8c-.06-24.21-19.7-43.8-43.9-43.8zM154.2 291.19c0 18.81-11.61 47.31-48.36 47.25h-46.4V172.98h47.38c35.44 0 47.36 28.46 47.37 47.28l.01 70.93zm100.68-88.66H201.6v38.42h32.57v29.57H201.6v38.41h53.29v29.57h-62.18c-11.16.29-20.44-8.53-20.72-19.69V193.7c-.27-11.15 8.56-20.41 19.71-20.69h63.19l-.01 29.52zm103.64 115.29c-13.2 30.75-36.85 24.63-47.44 0l-38.53-144.8h32.57l29.71 113.72 29.57-113.72h32.58l-38.46 144.8z"></path></svg></a
>


          </nav>
        </div>
        <script src="/assets/js/prism.js"></script>
        <script src="/assets/js/prism-line-numbers.js"></script>
      </footer>
    </div>

    <!-- The big email subscribe modal content -->
    

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.10.0/components/prism-abap.min.js"></script>
    <script>
      $(document).ready(function() {
        $("pre code").each(function(i, block) {
          hljs.highlightBlock(block);
        });
      });
    </script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
      src="https://code.jquery.com/jquery-3.2.1.min.js"
      integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
      crossorigin="anonymous"
    ></script>
    <script
      type="text/javascript"
      src="/assets/js/jquery.fitvids.js"
    ></script>
    <script
      type="text/javascript"
      src="https://demo.ghost.io/assets/js/jquery.fitvids.js?v=724281a32e"
    ></script>

    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    

    <!-- Add Google Analytics  -->
    <!-- Google Analytics Tracking code -->
 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-142536212-1', 'auto');
  ga('send', 'pageview');

 </script>


    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
     <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>
 

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->
  </body>
</html>
